<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="alternate icon" class="js-site-favicon" type="image/png" href="https://mvflix.stream/pwa/icon.png">
    <link rel="icon" class="js-site-favicon" type="image/png" href="https://mvflix.stream/pwa/icon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>
      .mr-3{
        margin-right: 3px;
      }
      .hidden{
        display:none;
      }
    </style>
    <title>MVFLIX Torrent Server</title>
</head>
<nav class="navbar navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img src="https://mvflix.stream/pwa/icon.png" alt="" width="30" height="30" class="d-inline-block align-text-top">
      MVFlix
    </a>
    <a class="navbar-brand float-end btn btn-primary text-white" href="https://github.com/mafuth/MVFLIX-Torrent-Server">
      <i class="bi bi-github"></i> About
    </a>
  </div>
</nav>
<div class="container mt-3">

  <div class="row justify-content-center mt-3">

    <div class="col-md-6">
      <div class="card bg-light">
        <div class="text-center mb-3 mt-3">
          <h1>MVFLIX Torrent API Server</h1>
        </div>
        <div class="container mt-3">
          <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon1">Torrent</span>
            <input type="text" class="form-control url" placeholder="magnet:?..." aria-label="magnet:?..." aria-describedby="magnet:?...">
          </div>
          <div class="input-group mb-3">
            <button class="btn btn-success download"><i class="bi bi-cloud-arrow-down-fill"></i> Download</button>
          </div>
          <div class="input-group mb-3">
            <button class="btn btn-warning loading hidden"><i class="bi bi-arrow-repeat"></i> Loading torrent info</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-12 mt-3 mb-3"></div>

    <div class="col-md-6 no-tor">
      <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-circle-fill"></i> No active torrents
      </div>
    </div>

    <div class="col-md-12 mt-3 mb-3"></div>

    <div class="col-md-12 torrents"></div>

    <div class="col-md-12 mt-3 mb-3"></div>
    <div class="col-md-12 mt-3 mb-3"></div>

  </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  const getMobileOS = () => {
    const ua = navigator.userAgent
    if (/android/i.test(ua)) {
      return "Android"
    }
    else if (/iPad|iPhone|iPod/.test(ua)){
      return "iOS"
    }
    return "Other"
  }
  function bytesToMegaBytes(bytes, roundTo) {
    var converted = bytes / (1024*1024);
    return roundTo ? converted.toFixed(roundTo) : converted;
  }
  function constructSingleFile(item, index){
    if(item['name'].endsWith('.mp4') || item['name'].endsWith('.mkv') || item['name'].endsWith('.avi'))
    {
      var os = getMobileOS();
      var host = window.location.host;
      if(os == "iOS"){
        $('.files:first').append(
        '<li class="list-group-item">'+
          '<a class="float-start" href="'+item['download']+'"> '+item['name']+' ( '+bytesToMegaBytes(item['length'],2)+' MB )</a>'+
          '<a class="btn btn-success float-end" href="vlc-x-callback://x-callback-url/ACTION?url=http://'+host+''+item['download']+'"><i class="bi bi-film"></i> Stream</a>'+
        '</li>')
      }else{
        $('.files:first').append(
        '<li class="list-group-item">'+
          '<a class="float-start" href="'+item['download']+'"> '+item['name']+' ( '+bytesToMegaBytes(item['length'],2)+' MB )</a>'+
          '<a class="btn btn-success float-end" href="'+item['stream']+'"><i class="bi bi-film"></i> Stream</a>'+
        '</li>')
      }
    }
    else{
      $('.files:first').append(
      '<li class="list-group-item">'+
        '<a class="float-start" href="'+item['download']+'"> '+item['name']+' ( '+bytesToMegaBytes(item['length'],2)+' MB )</a>'+
        '<a class="btn btn-primary float-end" href="'+item['download']+'"><i class="bi bi-download"></i> Download</a>'+
      '</li>')
    }
    
  }
  function constructSingleTorrent(item, index){
    $('.no-tor').hide();
    var hash = "'"+item['infoHash']+"'";
    $('.torrents').prepend(
      '<div class="card bg-light mt-3 torrent-'+item['infoHash']+'">'+
        '<div class="card-header">'+
          '<p class="float-start"> '+item['name']+'</p>'+
          '<div class="float-end">'+
            '<a class="btn btn-primary mr-3" href="/torrents/'+item['infoHash']+'/archive"><i class="bi bi-file-zip-fill"></i></a>'+
            '<button class="btn btn-danger" onclick="deleteTorrent('+hash+')"><i class="bi bi-trash3-fill"></i></button>'+
          '</div>'+
        '</div>'+
        '<div class="card-body">'+
          '<ul class="list-group files">'+ 
          '</ul></div></div></div>'
    )
    item['files'].forEach(constructSingleFile)
    
  }
  function loadTorrents(){
    $.ajax({
      type:'GET',
      url:'/torrents',
      dataType: 'json',
      beforeSend:function(){ 
      },
      success:function(data){
        data.forEach(constructSingleTorrent)
      }
    });
  }

  $('.download').click(function(){
    $.ajax({
      type:'POST',
      url:'/torrents',
      data:JSON.stringify({ link: $('.url').val() }),
      contentType: "application/json; charset=utf-8",
      dataType: 'json',
      beforeSend:function(){ 
        $('.url').val('')
        $('.download').hide()
        $('.loading').show()
      },
      success:function(data){
        setTimeout(function() {
          $('.loading').hide()
          $('.download').show()
          $('.torrents').html('')
          loadTorrents()
        }, 10000);
      }
    });
  });

  function deleteTorrent(infoHash){
    $.ajax({
      type:'DELETE',
      url:'/torrents/'+infoHash,
      success:function(data){
        $('.torrents').html('')
        loadTorrents()
      }
    });
  }

  loadTorrents()
</script>